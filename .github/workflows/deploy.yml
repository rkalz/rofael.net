name: Deploy to Home Server

on:
  push:
    branches: [master]
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  validate:
    uses: ./.github/workflows/validate.yml

  deploy:
    runs-on: self-hosted
    needs: validate # Only run deploy if validation passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug environment
        run: |
          echo "=== Environment Debug ==="
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo "PWD: $(pwd)"
          echo "Working directory contents:"
          ls -la
          echo ""
          echo "Nginx config file:"
          ls -la nginx/rofael.net.conf
          echo ""
          echo "Full path to nginx config:"
          realpath nginx/rofael.net.conf
          echo ""
          echo "Testing sudo -l:"
          sudo -l | grep cp
          echo "======================="

      - name: Check what files changed
        id: changes
        run: |
          echo "Checking for changed files..."
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger - deploying all"
            echo "files=all" >> $GITHUB_OUTPUT
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 2>/dev/null || echo "all")
            echo "Changed files: $CHANGED_FILES"
            echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          fi

      - name: Update nginx config if changed
        if: contains(steps.changes.outputs.files, 'nginx/') || contains(steps.changes.outputs.files, 'all')
        run: |
          echo "Nginx config changed, updating..."
          sudo /usr/bin/cp /home/ghrunner/actions-runner/_work/rofael.net/rofael.net/nginx/rofael.net.conf /etc/nginx/sites-available/rofael.net
          sudo /usr/sbin/nginx -t
          sudo /usr/sbin/nginx -s reload
          echo "✅ Nginx reloaded"

      - name: Ensure nginx symlink exists
        run: |
          if [ ! -L /etc/nginx/sites-enabled/rofael.net ]; then
            echo "Symlink doesn't exist, creating it..."
            sudo /usr/bin/ln -s /etc/nginx/sites-available/rofael.net /etc/nginx/sites-enabled/rofael.net
            sudo /usr/sbin/nginx -t
            sudo /usr/sbin/nginx -s reload
            echo "✅ Symlink created and nginx reloaded"
          else
            echo "✅ Symlink already exists"
          fi

      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t rofael-net:latest .
          echo "✅ Docker image built"

      - name: Stop old container
        run: |
          echo "Stopping old container..."
          docker stop rofael-net-container 2>/dev/null || true
          docker rm rofaetn-net-container 2>/dev/null || true
          echo "✅ Old container stopped"

      - name: Start new container
        run: |
          echo "Starting new container..."
          docker run -d \
            --name rofael-net-container \
            --restart unless-stopped \
            -p 127.0.0.1:8081:80 \
            rofael-net:latest
          echo "✅ Container started"

      - name: Verify deployment
        run: |
          echo "Waiting for container to start..."
          sleep 3
          if docker ps | grep -q rofael-net-container; then
            echo "✅ Deployment successful!"
            docker ps | grep rofael-net-container
          else
            echo "❌ Deployment failed!"
            docker logs rofael-net-container
            exit 1
          fi

      - name: Cleanup old images
        run: |
          echo "Cleaning up old Docker images..."
          docker image prune -f
          echo "✅ Cleanup complete"

      - name: Show deployment summary
        if: always()
        run: |
          echo "=== Deployment Summary ==="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Status: ${{ job.status }}"
          echo "======================="

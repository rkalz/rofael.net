name: Deploy to Home Server

on:
  push:
    branches: [master]
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  validate:
    uses: ./.github/workflows/validate.yml

  deploy:
    runs-on: self-hosted
    needs: validate # Only run deploy if validation passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 2

      - name: Check what files changed
        id: changes
        run: |
          echo "Checking for changed files..."
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger - deploying all"
            echo "files=all" >> $GITHUB_OUTPUT
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 2>/dev/null || echo "all")
            # Convert newlines to spaces for single-line output
            CHANGED_FILES_ONELINE=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            echo "Changed files: $CHANGED_FILES_ONELINE"
            echo "files=$CHANGED_FILES_ONELINE" >> $GITHUB_OUTPUT
          fi

      - name: Update nginx config if changed
        if: contains(steps.changes.outputs.files, 'nginx/') || contains(steps.changes.outputs.files, 'all')
        run: |
          echo "Nginx config changed, updating..."
          sudo /usr/bin/cp /home/ghrunner/actions-runner/_work/rofael.net/rofael.net/nginx/rofael.net.conf /etc/nginx/sites-available/rofael.net
          sudo /usr/sbin/nginx -t
          sudo /usr/sbin/nginx -s reload
          echo "✅ Nginx reloaded"

      - name: Ensure nginx symlink exists
        run: |
          if [ ! -L /etc/nginx/sites-enabled/rofael.net ]; then
            echo "Symlink doesn't exist, creating it..."
            sudo /usr/bin/ln -s /etc/nginx/sites-available/rofael.net /etc/nginx/sites-enabled/rofael.net
            sudo /usr/sbin/nginx -t
            sudo /usr/sbin/nginx -s reload
            echo "✅ Symlink created and nginx reloaded"
          else
            echo "✅ Symlink already exists"
          fi

      - name: Capture old image id (for cleanup)
        id: oldimage
        run: |
          set -euo pipefail
          OLD_IMAGE_ID=$(docker inspect -f '{{.Image}}' rofael-net-container 2>/dev/null || true)
          echo "old_image_id=$OLD_IMAGE_ID" >> "$GITHUB_OUTPUT"
          echo "Old image id: $OLD_IMAGE_ID"

      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t rofael-net:${{ github.sha }} -t rofael-net:latest .
          echo "✅ Docker image built"

      - name: Determine which port to use
        id: ports
        run: |
          # Check which port the current container is using
          if docker ps --format '{{.Names}}\t{{.Ports}}' 2>/dev/null | grep rofael-net-container | grep -q "8081->80"; then
            echo "Current container on port 8081, will use 8082 for new"
            echo "old_port=8081" >> $GITHUB_OUTPUT
            echo "new_port=8082" >> $GITHUB_OUTPUT
            echo "old_name=rofael-net-container" >> $GITHUB_OUTPUT
            echo "new_name=rofael-net-container-new" >> $GITHUB_OUTPUT
          else
            echo "Current container on port 8082 (or not running), will use 8081 for new"
            echo "old_port=8082" >> $GITHUB_OUTPUT
            echo "new_port=8081" >> $GITHUB_OUTPUT
            echo "old_name=rofael-net-container" >> $GITHUB_OUTPUT
            echo "new_name=rofael-net-container-new" >> $GITHUB_OUTPUT
          fi

      - name: Start new container
        run: |
          echo "Starting new container on port ${{ steps.ports.outputs.new_port }}..."
          docker run -d \
            --name ${{ steps.ports.outputs.new_name }} \
            --restart unless-stopped \
            -p 127.0.0.1:${{ steps.ports.outputs.new_port }}:80 \
            rofael-net:latest
          echo "✅ New container started"

      - name: Health check new container
        run: |
          echo "Waiting for new container to be ready..."
          sleep 3

          # Check if container is running
          if ! docker ps | grep -q ${{ steps.ports.outputs.new_name }}; then
            echo "❌ New container failed to start!"
            docker logs ${{ steps.ports.outputs.new_name }}
            exit 1
          fi

          # Check if container is responding
          MAX_ATTEMPTS=10
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -f -s http://127.0.0.1:${{ steps.ports.outputs.new_port }} > /dev/null 2>&1; then
              echo "✅ New container is healthy and responding"
              exit 0
            fi
            echo "Attempt $((ATTEMPT+1))/$MAX_ATTEMPTS: Container not ready yet..."
            sleep 2
            ATTEMPT=$((ATTEMPT+1))
          done

          echo "❌ New container not responding after $MAX_ATTEMPTS attempts!"
          docker logs ${{ steps.ports.outputs.new_name }}
          exit 1

      - name: Stop old container
        run: |
          echo "Stopping old container..."
          docker rm -f ${{ steps.ports.outputs.old_name }} 2>/dev/null || true
          echo "✅ Old container removed"

      - name: Rename new container to standard name
        run: |
          echo "Renaming new container..."
          docker rename ${{ steps.ports.outputs.new_name }} rofael-net-container
          echo "✅ Container renamed to rofael-net-container"

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          if docker ps | grep -q rofael-net-container; then
            echo "✅ Deployment successful!"
            docker ps | grep rofael-net-container
          else
            echo "❌ Deployment verification failed!"
            exit 1
          fi

      - name: Delete old image after successful deploy
        if: success()
        run: |
          set -euo pipefail
          OLD_IMAGE_ID='${{ steps.oldimage.outputs.old_image_id }}'

          if [ -n "$OLD_IMAGE_ID" ]; then
            echo "Deleting old image: $OLD_IMAGE_ID"
            docker rmi -f "$OLD_IMAGE_ID" || true
            echo "✅ Old image deleted"
          else
            echo "No old image to delete (container didn't exist)."
          fi

      - name: Cleanup dangling images
        if: success()
        run: |
          echo "Cleaning up dangling Docker images..."
          docker image prune -f
          echo "✅ Cleanup complete"

      - name: Show deployment summary
        if: always()
        run: |
          echo "=== Deployment Summary ==="
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Status: ${{ job.status }}"
          echo "Port used: ${{ steps.ports.outputs.new_port }}"
          echo "======================="

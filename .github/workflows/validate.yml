name: Validate Server Configuration

on:
  workflow_call: # Can be called by other workflows
  workflow_dispatch: # Can be run manually

jobs:
  validate:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Verify sudoers configuration
        run: |
          echo "=== Checking sudoers configuration ==="

          # Check if we can run sudo -l without password
          if ! sudo -n -l > /dev/null 2>&1; then
            echo "❌ Error: Cannot run sudo -l without password"
            exit 1
          fi

          echo "✅ Sudoers file is readable"

          # Show what commands are allowed
          echo ""
          echo "Allowed sudo commands:"
          SUDO_LIST=$(sudo -l)
          echo "$SUDO_LIST" | grep NOPASSWD || echo "⚠️  Warning: No NOPASSWD entries found"

          # Test each required command by checking if it's in the list
          echo ""
          echo "Testing required sudo commands..."

          # Test cp
          if echo "$SUDO_LIST" | grep -q "/usr/bin/cp.*rofael.net.conf"; then
            echo "✅ /usr/bin/cp (nginx config) is allowed"
          else
            echo "❌ /usr/bin/cp (nginx config) is NOT allowed"
            exit 1
          fi

          # Test ln
          if echo "$SUDO_LIST" | grep -q "/usr/bin/ln.*rofael.net"; then
            echo "✅ /usr/bin/ln (symlink) is allowed"
          else
            echo "❌ /usr/bin/ln (symlink) is NOT allowed"
            exit 1
          fi

          # Test nginx -t
          if echo "$SUDO_LIST" | grep -q "nginx -t"; then
            echo "✅ /usr/sbin/nginx -t is allowed"
          else
            echo "❌ /usr/sbin/nginx -t is NOT allowed"
            exit 1
          fi

          # Test nginx -s reload
          if echo "$SUDO_LIST" | grep -q "nginx -s reload"; then
            echo "✅ /usr/sbin/nginx -s reload is allowed"
          else
            echo "❌ /usr/sbin/nginx -s reload is NOT allowed"
            exit 1
          fi

          echo ""
          echo "=== All sudoers checks passed! ==="

      - name: Verify Docker access
        run: |
          echo "=== Checking Docker configuration ==="

          if ! docker ps > /dev/null 2>&1; then
            echo "❌ Error: Cannot access Docker"
            exit 1
          fi

          echo "✅ Docker is accessible"
          docker --version

      - name: Verify nginx configuration syntax
        run: |
          echo "=== Checking nginx configuration ==="

          # Check if nginx config exists in repo
          if [ ! -f nginx/rofael.net.conf ]; then
            echo "❌ Error: nginx/rofael.net.conf not found in repo"
            exit 1
          fi

          echo "✅ nginx/rofael.net.conf exists in repo"

          # Check if sites-available directory exists
          if [ ! -d /etc/nginx/sites-available ]; then
            echo "❌ Error: /etc/nginx/sites-available directory not found"
            exit 1
          fi

          echo "✅ /etc/nginx/sites-available directory exists"

          # Check if sites-enabled directory exists
          if [ ! -d /etc/nginx/sites-enabled ]; then
            echo "❌ Error: /etc/nginx/sites-enabled directory not found"
            exit 1
          fi

          echo "✅ /etc/nginx/sites-enabled directory exists"

          # Basic syntax validation (check for common mistakes)
          echo ""
          echo "Performing basic syntax checks..."

          # Check for upstream block
          if ! grep -q "upstream rofael_backend" nginx/rofael.net.conf; then
            echo "⚠️  Warning: upstream block not found in config"
          else
            echo "✅ upstream block found"
          fi

          # Check for both ports in upstream
          if grep -q "127.0.0.1:8081" nginx/rofael.net.conf && grep -q "127.0.0.1:8082" nginx/rofael.net.conf; then
            echo "✅ Both deployment ports configured in upstream"
          else
            echo "⚠️  Warning: Both ports (8081 and 8082) should be in upstream block"
          fi

          # Check for SSL certificate paths
          if grep -q "/etc/letsencrypt/live/rofael.net/fullchain.pem" nginx/rofael.net.conf; then
            echo "✅ SSL certificate path configured"
          else
            echo "❌ SSL certificate path not found"
            exit 1
          fi

          # Check for balanced brackets
          OPEN_BRACES=$(grep -o "{" nginx/rofael.net.conf | wc -l)
          CLOSE_BRACES=$(grep -o "}" nginx/rofael.net.conf | wc -l)

          if [ "$OPEN_BRACES" -eq "$CLOSE_BRACES" ]; then
            echo "✅ Balanced braces ({ and })"
          else
            echo "❌ Unbalanced braces: $OPEN_BRACES open, $CLOSE_BRACES close"
            exit 1
          fi

          echo ""
          echo "Note: Full nginx syntax validation will occur during deployment"
          echo "=== All nginx checks passed! ==="

      - name: Verify SSL certificates
        run: |
          echo "=== Checking SSL certificates ==="

          if [ ! -f /etc/letsencrypt/live/rofael.net/fullchain.pem ]; then
            echo "⚠️  Warning: SSL certificate not found at /etc/letsencrypt/live/rofael.net/fullchain.pem"
            echo "You may need to run: sudo certbot certonly --dns-cloudflare -d rofael.net"
          else
            echo "✅ SSL certificate exists"

            # Check expiration
            EXPIRY=$(sudo openssl x509 -enddate -noout -in /etc/letsencrypt/live/rofael.net/fullchain.pem | cut -d= -f2)
            EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s)
            NOW_EPOCH=$(date +%s)
            DAYS_UNTIL_EXPIRY=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))

            echo "Certificate expires: $EXPIRY"
            echo "Days until expiration: $DAYS_UNTIL_EXPIRY"

            if [ $DAYS_UNTIL_EXPIRY -lt 30 ]; then
              echo "⚠️  Warning: Certificate expires in less than 30 days!"
            fi
          fi

      - name: Check port availability
        run: |
          echo "=== Checking port availability ==="

          # Check which ports are in use
          PORT_8081_IN_USE=$(docker ps --format '{{.Ports}}' 2>/dev/null | grep -c "8081->80" || echo "0")
          PORT_8082_IN_USE=$(docker ps --format '{{.Ports}}' 2>/dev/null | grep -c "8082->80" || echo "0")

          echo "Port 8081 in use: $PORT_8081_IN_USE container(s)"
          echo "Port 8082 in use: $PORT_8082_IN_USE container(s)"

          if [ "$PORT_8081_IN_USE" -gt 0 ] && [ "$PORT_8082_IN_USE" -gt 0 ]; then
            echo "⚠️  Warning: Both deployment ports are in use"
            echo "This might cause issues during deployment"
          else
            echo "✅ At least one deployment port is available"
          fi

      - name: Verify Dockerfile exists
        run: |
          echo "=== Checking Dockerfile ==="

          if [ ! -f Dockerfile ]; then
            echo "❌ Error: Dockerfile not found in repository root"
            exit 1
          fi

          echo "✅ Dockerfile exists"

      - name: Test Docker build (optional)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=== Testing Docker build ==="
          echo "Building test image..."

          if docker build -t rofael-net:test . > /dev/null 2>&1; then
            echo "✅ Docker build successful"
            docker rmi rofael-net:test
          else
            echo "❌ Docker build failed"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=== Validation Summary ==="
          echo "Status: ${{ job.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "======================="
